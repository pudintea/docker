Docker Compose ‚Äì MinIO (Single Node)
> nano docker-compose.yml

version: "3.9"

services:
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    ports:
      - "9000:9000"   # S3 API
      - "9001:9001"   # Web Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    volumes:
      - ./minio/data:/data
    command: server /data --console-address ":9001"
    networks:
      - minio-net

networks:
  minio-net:
    driver: bridge

Tambahkan user ke grup docker
Jika kamu menggunakan user lain, tambahkan dulu dia ke group docker
> sudo usermod -aG docker $USER

Jalankan MinIO
> docker compose up -d

Error
Solusi (opsional tapi rapi)
Boleh hapus baris ini saja:
version: "3.9"

Cek:
> docker ps

Akses MinIO Console
Buka browser:
http://localhost:9001


Login:
User: minioadmin
Pass: minioadmin123

Buat Bucket
Menu Buckets
Create Bucket
Nama: pdn-bucket


Akses Seperti AWS S3
MinIO 100% kompatibel AWS SDK.

Contoh .env AWS
-----------------
export AWS_ACCESS_KEY_ID=admin
export AWS_SECRET_ACCESS_KEY=passwordkuat
export AWS_ENDPOINT_URL=http://127.0.0.1:9000

Contoh (Node.js)
-----------------
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3";

const s3 = new S3Client({
  endpoint: "http://127.0.0.1:9000",
  region: "us-east-1",
  credentials: {
    accessKeyId: "admin",
    secretAccessKey: "passwordkuat"
  },
  forcePathStyle: true
});

await s3.send(new PutObjectCommand({
  Bucket: "my-bucket",
  Key: "hello.txt",
  Body: "Hello MinIO!"
}));


Public Access (Optional)
Bucket Policy ‚Üí Public Read

Via Console:
Bucket ‚Üí Access Policy

Pilih Public
Atau via CLI:
mc anonymous set public localminio/my-bucket

Akses:
http://IP_SERVER:9000/my-bucket/hello.txt


INTEGRASI DENGAN CODEIGNITER 4
==============================
Install AWS SDK for PHP

Masuk ke folder CI4:
> composer require aws/aws-sdk-php

Konfigurasi .env CodeIgniter 4
------------------------------
Edit file .env:

MINIO_ENDPOINT=http://localhost:9000
MINIO_KEY=minioadmin
MINIO_SECRET=minioadmin123
MINIO_BUCKET=ci4-bucket
MINIO_REGION=us-east-1


Pastikan .env aktif:
CI_ENVIRONMENT=development

Buat Service MinIO
> app/Services/MinioService.php
<?php
namespace App\Services;
use Aws\S3\S3Client;
class MinioService
{
    public function client(): S3Client
    {
        return new S3Client([
            'version'  => 'latest',
            'region'   => getenv('MINIO_REGION'),
            'endpoint' => getenv('MINIO_ENDPOINT'),
            'use_path_style_endpoint' => true,
            'credentials' => [
                'key'    => getenv('MINIO_KEY'),
                'secret' => getenv('MINIO_SECRET'),
            ],
        ]);
    }
}

Daftarkan Service (opsional tapi rapi)
---------------------------------------
> app/Config/Services.php
public static function minio(bool $getShared = true)
{
    if ($getShared) {
        return static::getSharedInstance('minio');
    }

    return new \App\Services\MinioService();
}

Upload File dari Controller
----------------------------
> nano app/Controllers/Upload.php
<?php
namespace App\Controllers;
class Upload extends BaseController
{
    public function index()
    {
        return view('upload_form');
    }

    public function store()
    {
        $file = $this->request->getFile('file');

        if (! $file->isValid()) {
            return 'File tidak valid';
        }

        $minio = service('minio')->client();

        $minio->putObject([
            'Bucket' => getenv('MINIO_BUCKET'),
            'Key'    => 'uploads/' . $file->getRandomName(),
            'Body'   => fopen($file->getTempName(), 'r'),
            'ContentType' => $file->getClientMimeType(),
        ]);

        return 'Upload ke MinIO berhasil!';
    }
}

Form Upload
-------------
> nano app/Views/upload_form.php
<form method="post" enctype="multipart/form-data" action="/upload">
  <input type="file" name="file" required>
  <button type="submit">Upload</button>
</form>

Routing
--------
> nano app/Config/Routes.php
$routes->get('upload', 'Upload::index');
$routes->post('upload', 'Upload::store');

D. TEST END-TO-END

Jalankan CI4:
php spark serve
Buka:
http://localhost:8080/upload

Upload file
Cek di MinIO Console ‚Üí Bucket ‚Üí uploads/
SUCCESS! CI4 ‚Üí MinIO via Docker


===========================================================

Contoh Docker Compose: MinIO + CI4
> nano docker-compose.yml

version: "3.9"

services:
  minio:
    image: minio/minio:latest
    container_name: minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    volumes:
      - ./minio/data:/data
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - app-net

  ci4:
    image: php:8.2-apache
    container_name: ci4
    volumes:
      - ./ci4:/var/www/html
    ports:
      - "8080:80"
    depends_on:
      - minio
    networks:
      - app-net
    environment:
      MINIO_ENDPOINT: http://minio:9000
      MINIO_KEY: minioadmin
      MINIO_SECRET: minioadmin123
      MINIO_BUCKET: ci4-bucket
      MINIO_REGION: us-east-1

networks:
  app-net:
    driver: bridge


BACKUP
========================================================================
Install MinIO Client (mc)
Kalau belum:
> wget https://dl.min.io/client/mc/release/linux-amd64/mc
> chmod +x mc
> sudo mv mc /usr/local/bin/mc
> mc --version

OPSI 3 ‚Äî Backup + Versioning (PALING AMAN)
Aktifkan versioning
> mc version enable minio/pdn-bucket

Backup dengan version
> mc mirror --overwrite --versions minio /backup/minio

‚úîÔ∏è Aman dari:
File terhapus
File ketimpa


Aku bikinkan script lengkap, siap pakai, dan production-friendly untuk:
‚úÖ Buat bucket
‚úÖ Aktifkan versioning
‚úÖ Pasang lifecycle policy
‚úÖ (Opsional) set public/private
‚úÖ Aman dijalankan berulang (idempotent)

Aku jelaskan sekali, lalu kamu bisa pakai selamanya.

1Ô∏è‚É£ Prasyarat (sekali saja)

Pastikan:
> mc --version


Alias MinIO sudah ada:
> mc alias set minio http://localhost:9000 minioadmin minioadmin123

2Ô∏è‚É£ Lifecycle Policy (Template)
> nano lifecycle-versioned.json

Use case: upload user, dokumen, foto (AMAN & HEMAT)

{
  "Rules": [
    {
      "ID": "expire-old-versions",
      "Status": "Enabled",
      "NoncurrentVersionExpiration": {
        "NoncurrentDays": 30
      }
    },
    {
      "ID": "cleanup-delete-marker",
      "Status": "Enabled",
      "Expiration": {
        "ExpiredObjectDeleteMarker": true
      }
    }
  ]
}


üìå Artinya:
Versi lama disimpan 30 hari
Delete marker dibersihkan otomatis
Versi aktif tidak dihapus

3Ô∏è‚É£ Script Lengkap: Bucket + Versioning + Policy
> nano create-bucket.sh
#!/bin/bash
set -e

# ===== CONFIG =====
ALIAS="minio"
LIFECYCLE_FILE="lifecycle-versioned.json"

BUCKET=$1
ACCESS=${2:-private}   # private | public

# ===== VALIDATION =====
if [ -z "$BUCKET" ]; then
  echo "‚ùå Usage: ./create-bucket.sh bucket-name [public|private]"
  exit 1
fi

if [ ! -f "$LIFECYCLE_FILE" ]; then
  echo "‚ùå Lifecycle file not found: $LIFECYCLE_FILE"
  exit 1
fi

echo "üöÄ Setting up bucket: $BUCKET"

# ===== CREATE BUCKET =====
mc mb $ALIAS/$BUCKET --ignore-existing

# ===== ENABLE VERSIONING =====
mc version enable $ALIAS/$BUCKET || true

# ===== APPLY LIFECYCLE =====
mc ilm import $ALIAS/$BUCKET $LIFECYCLE_FILE

# ===== ACCESS POLICY =====
if [ "$ACCESS" == "public" ]; then
  mc anonymous set public $ALIAS/$BUCKET
  echo "üåç Bucket set to PUBLIC"
else
  mc anonymous set none $ALIAS/$BUCKET
  echo "üîê Bucket set to PRIVATE"
fi

echo "‚úÖ Bucket '$BUCKET' ready!"


4Ô∏è‚É£ Jadikan Executable
> chmod +x create-bucket.sh

5Ô∏è‚É£ Cara Pakai
Bucket private (default)
> ./create-bucket.sh pdn-bucket

Bucket public
./create-bucket.sh user-uploads public

6Ô∏è‚É£ Verifikasi
mc version info minio/pdn-bucket
mc ilm ls minio/pdn-bucket
mc anonymous get minio/pdn-bucket

















// PUDIN SAEPUDIN
